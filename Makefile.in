
# This file could have been written in more
# elegant manner, but I'm fine with it's current
# state.

# Kamila Szewczyk, Jul 2019

export CFLAGS=-Ofast -march=native -funroll-loops -fomit-frame-pointer -w $(COVERAGE)
TARGETS=bfasm bfvm bfi bconv bfstrip bfderle bflabels constpp bfdata effective vxcall
VERSION=trunk

.PHONY: all clean install test bfpp redpower uninstall distclean dist

all: $(TARGETS) bfpp etc/bfasm.b bin

install:
	rm -rf "${HOME}/.asmbf/"
	mkdir -p "${HOME}/.asmbf/"
	cp -rf bin/asmbf/* "${HOME}/.asmbf/"
	chmod -R a+x "${HOME}/.asmbf/"
	echo "asm2bf has been installed to ${HOME}/.asmbf/."

dist: clean distclean test-clean
	mkdir "asm2bf-$(VERSION)"
	cp -rf b2bf bfpp etc examples hla lib-bfm microcode preprocessor redpower test "asm2bf-$(VERSION)/"
	cp -rf *.* "asm2bf-$(VERSION)/"
	cd "asm2bf-$(VERSION)" && rm -f Makefile configure .travis.yml .editorconfig .gitattributes && cd ..
	tar -cf "asm2bf-$(VERSION).tar" "asm2bf-$(VERSION)/"
	rm -rf "asm2bf-$(VERSION)"

distclean:
	rm -f config.log config.status redpower/Makefile hla/Makefile etc/bfasm.b
	rm -rf autom4te.cache

redpower:
	make -C redpower

bfpp:
	make -C bfpp

test: test/*.asm
	chmod a+x test/test.pl $^
	-bfi --help 2> /dev/null
	-bfi --version 2> /dev/null
	-bfi --blah 2> /dev/null
	test/test.pl $^

uninstall:
	rm -rf "${HOME}/.asmbf/"

clean:
	rm -rf bin/
	rm -f preprocessor/*.c config.h asm2bf-*.tar
	-cd bfpp && make clean && cd ..
	-cd redpower && make clean && cd ..

etc/bfasm.b: bfasm bfstrip etc/bfasm.asm
	./bfasm < etc/bfasm.asm | ./bfstrip > $@

bin: $(TARGETS)
	mkdir -p bin
	mkdir -p bin/asmbf
	mkdir -p bin/asmbf/lib
	cp $(TARGETS) bfpp/bfpp bfmake bfi-rle bin/asmbf/
	cp lib-bfm/*.lua bin/asmbf/lib/
	rm -rf $(TARGETS)
	
test-clean:
	rm -f test/*.aout
	rm -f test/*.b

preprocessor/%.c: preprocessor/%.lex
	lex -f -o $@ $<

%: preprocessor/%.c
	$(CC) $(CFLAGS) -o $@ $<
